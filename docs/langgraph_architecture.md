# LangGraph 状态编排架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                   LangGraph Agent 架构                            │
└─────────────────────────────────────────────────────────────────┘

    用户请求
       │
       ▼
    ┌──────────────────────────────────────────────────────────┐
    │                    AgentGraph                            │
    │  状态编排核心 - LangGraph StateGraph                     │
    └──────────────────────────────────────────────────────────┘
                           │
                           │ 初始化状态
                           ▼
    ┌──────────────────────────────────────────────────────────┐
    │                    AgentState                            │
    │  ┌────────────────────────────────────────────────────┐ │
    │  │ session_id: str                                    │ │
    │  │ user_message: str                                  │ │
    │  │ intent: Optional[str]                              │ │
    │  │ intent_confidence: float                           │ │
    │  │ selected_skills: List[str]                         │ │
    │  │ skill_results: List[SkillExecutionResult]          │ │
    │  │ messages: List[BaseMessage]                        │ │
    │  │ final_response: Optional[str]                      │ │
    │  │ metadata: Dict[str, Any]                           │ │
    │  └────────────────────────────────────────────────────┘ │
    └──────────────────────────────────────────────────────────┘
                           │
                           │ 状态流转
                           ▼
    ┌──────────────────────────────────────────────────────────┐
    │              Node 1: intent_recognition                  │
    │  ┌────────────────────────────────────────────────────┐ │
    │  │ 1. IntentRecognizer.recognize()                    │ │
    │  │    ├─ LLM 模式（智谱 AI GLM-4）                    │ │
    │  │    └─ 规则匹配模式（降级）                          │ │
    │  │                                                    │ │
    │  │ 2. 更新状态:                                       │ │
    │  │    - state['intent'] = 识别的意图                  │ │
    │  │    - state['intent_confidence'] = 置信度            │ │
    │  │    - state['selected_skills'] = Skills 列表        │ │
    │  │                                                    │ │
    │  │ 3. 添加消息历史:                                   │ │
    │  │    state['messages'].append(AIMessage(...))        │ │
    │  └────────────────────────────────────────────────────┘ │
    └────────────────────┬─────────────────────────────────────┘
                         │
                         │ edge
                         ▼
    ┌──────────────────────────────────────────────────────────┐
    │              Node 2: skill_execution                     │
    │  ┌────────────────────────────────────────────────────┐ │
    │  │ for skill_name in state['selected_skills']:        │ │
    │  │   1. SkillRegistry.get(skill_name)                │ │
    │  │   2. 构建 Skill 输入参数                           │ │
    │  │   3. skill.execute(input_data, context)            │ │
    │  │   4. 记录 SkillExecutionResult                     │ │
    │  │      - skill_name                                  │ │
    │  │      - success                                    │ │
    │  │      - data                                       │ │
    │  │      - error                                      │ │
    │  │      - execution_time                             │ │
    │  │   5. 添加消息历史                                  │ │
    │  └────────────────────────────────────────────────────┘ │
    └────────────────────┬─────────────────────────────────────┘
                         │
                         │ edge
                         ▼
    ┌──────────────────────────────────────────────────────────┐
    │           Node 3: response_generation                    │
    │  ┌────────────────────────────────────────────────────┐ │
    │  │ if state['skill_results']:                         │ │
    │  │   # 有 Skill 执行结果                               │ │
    │  │   格式化 Skill 数据                                 │ │
    │  │   生成结构化回复                                    │ │
    │  │ else:                                              │ │
    │  │   # 无 Skill 执行（对话模式）                        │ │
    │  │   生成对话回复                                      │ │
    │  │                                                    │ │
    │  │ state['final_response'] = 生成的回复               │ │
    │  │ state['messages'].append(AIMessage(...))           │ │
    │  └────────────────────────────────────────────────────┘ │
    └────────────────────┬─────────────────────────────────────┘
                         │
                         │ edge
                         ▼
                    END 节点
                         │
                         ▼
                    返回结果


┌─────────────────────────────────────────────────────────────────┐
│                  意图识别双模式架构                               │
└─────────────────────────────────────────────────────────────────┘

    IntentRecognizer.recognize(message, context)
              │
              ├──────────────────────────────┐
              │                             │
         API Key 已配置                  API Key 未配置
              │                             │
              ▼                             ▼
    ┌──────────────────┐          ┌──────────────────┐
    │   LLM 模式        │          │  规则匹配模式     │
    └──────────────────┘          └──────────────────┘
              │                             │
              │                             │
              ▼                             ▼
    ┌──────────────────┐          ┌──────────────────┐
    │ 1. 构建 Prompt   │          │ 1. 关键词提取     │
    │    - 意图描述     │          │    - 分词         │
    │    - 用户消息     │          │    - 匹配         │
    │    - JSON 格式    │          │                   │
    │                  │          │ 2. 评分计算       │
    │ 2. 调用智谱 AI   │          │    - 每个意图得分  │
    │    - model_api   │          │    - 归一化       │
    │      .invoke()   │          │                   │
    │                  │          │ 3. 选择最高分     │
    │ 3. 解析 JSON 响应│          │                   │
    │    - intent      │          └──────────────────┘
    │    - confidence  │
    │    - parameters  │
    │    - reasoning   │
    │                  │
    └────────┬─────────┘
             │
             │ 成功
             ▼
       返回 LLM 结果

             │ 失败
             ▼
       降级到规则匹配


┌─────────────────────────────────────────────────────────────────┐
│                  意图到 Skill 映射                               │
└─────────────────────────────────────────────────────────────────┘

    ┌──────────────────────────────────────────────────────────┐
    │               IntentRecognizer.get_skill_mapping()       │
    └──────────────────────────────────────────────────────────┘
                          │
         ┌────────────────┼────────────────┐
         │                │                │
         ▼                ▼                ▼
    ┌─────────┐     ┌─────────┐     ┌─────────┐
    │query_   │     │generate │     │analyze_ │
    │metrics  │     |_report  │     |_root_   │
    └────┬────┘     └────┬────┘     └────┬────┘
         │               │               │
         ▼               ▼               ▼
    ┌─────────┐     ┌─────────┐     ┌─────────┐
    │Query    │     │Generate │     │Analyze  │
    │Metrics  │     │Report   │     │RootCause│
    │Skill    │     │Skill    │     │Skill    │
    └─────────┘     └─────────┘     └─────────┘


┌─────────────────────────────────────────────────────────────────┐
│                  消息历史结构                                    │
└─────────────────────────────────────────────────────────────────┘

    state['messages']: List[BaseMessage]

    ┌──────────────────────────────────────────────────────────┐
    │  消息 0: HumanMessage                                     │
    │  content: "查询最近7天的销售额"                           │
    └──────────────────────────────────────────────────────────┘
                           │
                           ▼
    ┌──────────────────────────────────────────────────────────┐
    │  消息 1: AIMessage                                        │
    │  content: "已识别意图: query_metrics (置信度: 0.61)       │
    │           推理过程: 基于关键词匹配...                      │
    │           将调用 Skills: QueryMetricsSkill"               │
    └──────────────────────────────────────────────────────────┘
                           │
                           ▼
    ┌──────────────────────────────────────────────────────────┐
    │  消息 2: AIMessage                                        │
    │  content: "✓ QueryMetricsSkill 执行成功                   │
    │           数据: {'region_id': 1, 'metric_value': 1000}..." │
    └──────────────────────────────────────────────────────────┘
                           │
                           ▼
    ┌──────────────────────────────────────────────────────────┐
    │  消息 3: AIMessage                                        │
    │  content: "✓ QueryMetricsSkill 执行成功                   │
    │           耗时: 0.01s                                     │
    │           结果: 共 10 条数据..."                          │
    └──────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────┐
│                  Skill 执行详细流程                              │
└─────────────────────────────────────────────────────────────────┘

    skill_name = "QueryMetricsSkill"
         │
         ▼
    ┌──────────────────────────────────────────────────────────┐
    │  1. SkillRegistry.get(skill_name)                        │
    └────────────────────┬─────────────────────────────────────┘
                         │
                         ▼
    ┌──────────────────────────────────────────────────────────┐
    │  2. 构建 Skill 输入                                      │
    │     _build_skill_input(                                  │
    │         skill_name,                                      │
    │         user_message,                                    │
    │         intent                                          │
    │     )                                                   │
    │                                                          │
    │  根据 intent 生成默认参数:                                │
    │  - query_metrics → QueryMetricsInput(...)                │
    │  - generate_report → GenerateReportInput(...)            │
    │  - analyze_root_cause → AnalyzeRootCauseInput(...)       │
    └────────────────────┬─────────────────────────────────────┘
                         │
                         ▼
    ┌──────────────────────────────────────────────────────────┐
    │  3. skill.execute(input_data, context)                   │
    │                                                          │
    │  ┌────────────────────────────────────────────────────┐ │
    │  │ Skill 内部执行:                                     │ │
    │  │ 1. 构建查询 SQL (QueryMetricsSkill)                │ │
    │  │ 2. mcp_client.call_tool("database_query", {...})    │ │
    │  │ 3. DatabaseQueryTool.execute()                     │ │
    │  │ 4. asyncpg 执行 SQL                                │ │
    │  │ 5. 返回结果                                        │ │
    │  └────────────────────────────────────────────────────┘ │
    └────────────────────┬─────────────────────────────────────┘
                         │
                         ▼
    ┌──────────────────────────────────────────────────────────┐
    │  4. 记录 SkillExecutionResult                            │
    │     {                                                   │
    │       "skill_name": "QueryMetricsSkill",                 │
    │       "success": True,                                   │
    │       "data": {...},                                     │
    │       "error": None,                                     │
    │       "execution_time": 0.01                             │
    │     }                                                   │
    └────────────────────┬─────────────────────────────────────┘
                         │
                         ▼
              state['skill_results'].append(result)


┌─────────────────────────────────────────────────────────────────┐
│                  流式事件 Streaming                              │
└─────────────────────────────────────────────────────────────────┘

    AgentGraph.stream_events(session_id, user_message)
                   │
                   ▼
    ┌──────────────────────────────────────────────────────────┐
    │  async for event in self.graph.astream(initial_state):   │
    │                                                          │
    │    yield {                                              │
    │      "type": "state_update",                             │
    │      "data": event                                       │
    │    }                                                    │
    └──────────────────────────────────────────────────────────┘
                   │
                   ▼
    SSE (Server-Sent Events) 流
                   │
                   ├─ event 1: intent_recognition 完成
                   ├─ event 2: skill_execution 开始
                   ├─ event 3: skill_execution 完成
                   └─ event 4: response_generation 完成


┌─────────────────────────────────────────────────────────────────┐
│                  错误处理和降级策略                              │
└─────────────────────────────────────────────────────────────────┘

    LLM API 调用失败
         │
         ▼
    ┌─────────────────────────────────────┐
    │  logger.error("LLM 失败")           │
    └────────────┬────────────────────────┘
                 │
                 ▼
    ┌─────────────────────────────────────┐
    │  降级到规则匹配                      │
    │  _rule_based_recognition()          │
    └────────────┬────────────────────────┘
                 │
                 ▼
    ┌─────────────────────────────────────┐
    │  关键词匹配                         │
    │  评分计算                           │
    │  返回结果                           │
    └─────────────────────────────────────┘


    Skill 执行失败
         │
         ▼
    ┌─────────────────────────────────────┐
    │  try:                               │
    │    result = await skill.execute()   │
    │  except Exception as e:             │
    │    skill_result = SkillExecutionResult( │
    │      skill_name=skill_name,         │
    │      success=False,                 │
    │      error=str(e)                   │
    │    )                                │
    └────────────┬────────────────────────┘
                 │
                 ▼
    继续执行下一个 Skill（不中断流程）


┌─────────────────────────────────────────────────────────────────┐
│                  关键数据结构                                    │
└─────────────────────────────────────────────────────────────────┘

    AgentState (TypedDict)
    {
        "session_id": "test_session_1",
        "user_message": "查询销售额",

        # 意图识别
        "intent": "query_metrics",
        "intent_confidence": 0.61,

        # Skill 执行
        "selected_skills": ["QueryMetricsSkill"],
        "skill_results": [
            {
                "skill_name": "QueryMetricsSkill",
                "success": True,
                "data": [...],
                "error": None,
                "execution_time": 0.01
            }
        ],

        # 消息历史
        "messages": [
            HumanMessage(content="查询销售额"),
            AIMessage(content="已识别意图..."),
            AIMessage(content="✓ Skill 执行成功..."),
            AIMessage(content="最终回复...")
        ],

        # 输出
        "final_response": "✓ QueryMetricsSkill 执行成功...",

        # 元数据
        "metadata": {
            "start_time": 1234567890.12,
            "execution_time": 0.05,
            "success": True
        }
    }


┌─────────────────────────────────────────────────────────────────┐
│                  性能和扩展性                                    │
└─────────────────────────────────────────────────────────────────┘

    性能优化:
    - 异步执行 (async/await)
    - Skill 并行执行（可扩展）
    - 连接池复用（PostgreSQL, Redis）
    - 状态图编译（LangGraph.compile()）

    扩展性:
    - 新意图: 在 IntentRecognizer.INTENTS 添加
    - 新 Skill: 在 SkillRegistry 注册
    - 新节点: workflow.add_node()
    - 新边: workflow.add_edge()

    可测试性:
    - 每个节点独立测试
    - Mock Skill 执行
    - 状态快照验证
    - 错误场景覆盖

---

**文档版本**: v1.0
**最后更新**: 2026-02-03
