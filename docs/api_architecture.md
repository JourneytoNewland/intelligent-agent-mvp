# FastAPI 集成架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                   FastAPI 应用架构                                │
└─────────────────────────────────────────────────────────────────┘

    客户端
       │
       │ HTTP 请求
       ▼
    ┌──────────────────────────────────────────────────────────┐
    │                  FastAPI 应用                             │
    │  ┌────────────────────────────────────────────────────┐ │
    │  │  中间件层                                          │ │
    │  │  - CORSMiddleware                                 │ │
    │  │  - ErrorHandlerMiddleware (未来)                  │ │
    │  │  - AuthenticationMiddleware (未来)                │ │
    │  │  - RateLimitMiddleware (未来)                      │ │
    │  └────────────────────────────────────────────────────┘ │
    │                           │                               │
    │                           ▼                               │
    │  ┌────────────────────────────────────────────────────┐ │
    │  │  路由层                                            │ │
    │  │  GET  /docs (Swagger UI)                          │ │
    │  │  GET  /redoc (ReDoc)                              │ │
    │  │  GET  /                                           │ │
    │  │  GET  /health                                     │ │
    │  │  POST /api/v1/chat/                               │ │
    │  │  POST /api/v1/chat/stream                         │ │
    │  │  GET  /api/v1/chat/sessions                       │ │
    │  │  GET  /api/v1/chat/sessions/{id}                  │ │
    │  │  GET  /api/v1/chat/sessions/{id}/history          │ │
    │  │  DELETE /api/v1/chat/sessions/{id}                │ │
    │  └────────────────────────────────────────────────────┘ │
    └──────────────────────────────────────────────────────────┘
                           │
                           │ 依赖注入
                           ▼
    ┌──────────────────────────────────────────────────────────┐
    │                  业务逻辑层                               │
    ├──────────────────────────────────────────────────────────┤
    │  ┌──────────────────┐    ┌──────────────────┐          │
    │  │ SessionManager   │    │   AgentGraph     │          │
    │  │                  │    │                  │          │
    │  │ - create_session │    │ - run()          │          │
    │  │ - get_session    │    │ - stream_events()│          │
    │  │ - update_session │    │                  │          │
    │  │ - add_message    │    │                  │          │
    │  │ - delete_session │    │                  │          │
    │  └────────┬─────────┘    └────────┬─────────┘          │
    │           │                       │                      │
    │           │    ┌──────────────────┴─────────┐           │
    │           │    │                            │           │
    │           ▼    ▼                            ▼           │
    │    ┌──────────────┐              ┌──────────────┐      │
    │    │     Redis    │              │ LangGraph    │      │
    │    │   (会话存储)  │              │  (状态编排)   │      │
    │    └──────────────┘              └──────────────┘      │
    │                                         │              │
    └─────────────────────────────────────────┼──────────────┘
                                              │
                                              │ 调用
                                              ▼
    ┌──────────────────────────────────────────────────────────┐
    │                    Agent 组件                              │
    ├──────────────────────────────────────────────────────────┤
    │  ┌──────────────────┐  ┌──────────────────┐             │
    │  │IntentRecognizer  │  │  SkillRegistry   │             │
    │  │                  │  │                  │             │
    │  │- recognize()     │  │- get()           │             │
    │  │- LLM 模式        │  │- list_skills()   │             │
    │  │- 规则匹配        │  │- get_tools()     │             │
    │  └──────────────────┘  └────────┬─────────┘             │
    │                                 │                         │
    │                                 ▼                         │
    │                  ┌─────────────────────┐                │
    │                  │      Skills         │                │
    │                  ├─────────────────────┤                │
    │                  │ QueryMetricsSkill   │                │
    │                  │ GenerateReportSkill │                │
    │                  │ AnalyzeRootCause    │                │
    │                  └──────────┬──────────┘                │
    │                             │                          │
    │                             ▼                          │
    │                  ┌─────────────────────┐                │
    │                  │     MCPClient       │                │
    │                  └──────────┬──────────┘                │
    └────────────────────────────┼──────────────────────────┘
                                   │
                                   │ 调用
                                   ▼
    ┌──────────────────────────────────────────────────────────┐
    │                      MCP 工具层                            │
    ├──────────────────────────────────────────────────────────┤
    │  ┌──────────────────┐    ┌──────────────────┐          │
    │  │DatabaseQueryTool │    │HttpRequestTool  │          │
    │  │                  │    │                 │          │
    │  │- execute()       │    │- execute()      │          │
    │  │- 参数化查询      │    │- HTTP 请求      │          │
    │  │- SQL 注入防护    │    │- 重试机制       │          │
    │  └────────┬─────────┘    └────────┬────────┘          │
    │           │                       │                     │
    └───────────┼───────────────────────┼─────────────────┘
                │                       │
                ▼                       ▼
    ┌─────────────────────┐    ┌─────────────────────┐
    │    PostgreSQL       │    │    HTTP API         │
    │  (数据库)           │    │  (外部服务)          │
    └─────────────────────┘    └─────────────────────┘


┌─────────────────────────────────────────────────────────────────┐
│                  聊天接口详细流程                                 │
└─────────────────────────────────────────────────────────────────┘

    POST /api/v1/chat/
    {
      "message": "查询最近7天的销售额",
      "session_id": null,  // 或提供现有会话 ID
      "stream": false
    }
         │
         ▼
    ┌──────────────────────────────────────────────────────────┐
    │  1. 参数验证 (Pydantic)                                  │
    │     ChatRequest                                          │
    │       - message: str (1-2000 字符)                       │
    │       - session_id: Optional[str]                       │
    │       - stream: bool                                     │
    └────────────┬─────────────────────────────────────────────┘
                 │
                 ▼
    ┌──────────────────────────────────────────────────────────┐
    │  2. 会话管理                                             │
    │     if session_id is None:                              │
    │       → session_manager.create_session()                │
    │          生成新 session_id                               │
    │          初始化消息历史                                  │
    │     else:                                               │
    │       → session_manager.add_user_message()              │
    │          添加到现有会话                                  │
    └────────────┬─────────────────────────────────────────────┘
                 │
                 ▼
    ┌──────────────────────────────────────────────────────────┐
    │  3. Agent 执行                                          │
    │     result = await agent.run(                           │
    │       session_id=session_id,                            │
    │       user_message=request.message                      │
    │     )                                                   │
    │                                                          │
    │     Agent 内部流程:                                      │
    │       a. intent_recognition                             │
    │          → 识别意图: query_metrics                      │
    │          → 选择 Skills: [QueryMetricsSkill]             │
    │                                                          │
    │       b. skill_execution                                │
    │          → 调用 QueryMetricsSkill.execute()             │
    │          → mcp_client.call_tool("database_query", ...)   │
    │          → DatabaseQueryTool.execute()                  │
    │          → 返回结果                                      │
    │                                                          │
    │       c. response_generation                            │
    │          → 格式化 Skill 结果                            │
    │          → 生成最终回复                                  │
    └────────────┬─────────────────────────────────────────────┘
                 │
                 ▼
    ┌──────────────────────────────────────────────────────────┐
    │  4. 更新会话                                             │
    │     session_manager.update_session(                     │
    │       session_id=session_id,                            │
    │       assistant_message=result["final_response"],       │
    │       state_update={                                     │
    │         "last_intent": result["intent"],                 │
    │         "last_confidence": result["intent_confidence"]   │
    │       }                                                  │
    │     )                                                   │
    └────────────┬─────────────────────────────────────────────┘
                 │
                 ▼
    ┌──────────────────────────────────────────────────────────┐
    │  5. 返回响应                                             │
    │     ChatResponse(                                        │
    │       session_id=session_id,                            │
    │       response=result["final_response"],                │
    │       intent=result["intent"],                          │
    │       confidence=result["intent_confidence"],           │
    │       skills_used=result["selected_skills"],            │
    │       execution_time=result["metadata"]["execution_time"]│
    │     )                                                   │
    └────────────┬─────────────────────────────────────────────┘
                 │
                 ▼
         HTTP 200 Response
    {
      "session_id": "session_abc123",
      "response": "✓ QueryMetricsSkill 执行成功...",
      "intent": "query_metrics",
      "confidence": 0.61,
      "skills_used": ["QueryMetricsSkill"],
      "execution_time": 0.26
    }


┌─────────────────────────────────────────────────────────────────┐
│                  SSE 流式聊天流程                                │
└─────────────────────────────────────────────────────────────────┘

    POST /api/v1/chat/stream
    {
      "message": "生成销售报表",
      "stream": true
    }
         │
         ▼
    ┌──────────────────────────────────────────────────────────┐
    │  1. 创建 SSE 流                                         │
    │     StreamingResponse(                                 │
    │       event_generator(),                                │
    │       media_type="text/event-stream"                    │
    │     )                                                   │
    └────────────┬─────────────────────────────────────────────┘
                 │
                 ▼
    ┌──────────────────────────────────────────────────────────┐
    │  2. 事件生成器                                           │
    │     async def event_generator():                        │
    │                                                          │
    │       # 发送会话 ID                                       │
    │       yield f"event: session\ndata: {{...}}\n\n"        │
    │                                                          │
    │       # 流式执行 Agent                                    │
    │       async for event in agent.stream_events(...):       │
    │         yield f"event: state_update\ndata: {{...}}\n\n"│
    │                                                          │
    │       # 发送最终结果                                       │
    │       yield f"event: complete\ndata: {{...}}\n\n"       │
    └────────────┬─────────────────────────────────────────────┘
                 │
                 ▼
    ┌──────────────────────────────────────────────────────────┐
    │  3. SSE 事件流                                           │
    │     event: session                                       │
    │     data: {"session_id": "session_abc123"}               │
    │                                                          │
    │     event: state_update                                  │
    │     data: {"node": "intent_recognition", ...}            │
    │                                                          │
    │     event: state_update                                  │
    │     data: {"node": "skill_execution", ...}               │
    │                                                          │
    │     event: complete                                      │
    │     data: {"response": "...", ...}                       │
    └──────────────────────────────────────────────────────────┘
                 │
                 ▼
           客户端接收流式数据


┌─────────────────────────────────────────────────────────────────┐
│                  Redis 会话存储结构                              │
└─────────────────────────────────────────────────────────────────┘

    Key: "session:{session_id}"
    TTL: 3600 秒（1 小时）

    Value (JSON):
    {
      "session_id": "session_abc123",
      "created_at": "2026-02-03T09:00:00",
      "updated_at": "2026-02-03T09:05:00",
      "message_count": 5,
      "messages": [
        {
          "role": "user",
          "content": "你好",
          "timestamp": "2026-02-03T09:00:00"
        },
        {
          "role": "assistant",
          "content": "您好！我是...",
          "timestamp": "2026-02-03T09:00:01"
        },
        {
          "role": "user",
          "content": "查询销售额",
          "timestamp": "2026-02-03T09:05:00"
        },
        {
          "role": "assistant",
          "content": "✓ 查询成功...",
          "timestamp": "2026-02-03T09:05:01"
        }
      ],
      "state": {
        "last_intent": "query_metrics",
        "last_confidence": 0.61,
        "last_skills": ["QueryMetricsSkill"]
      }
    }


┌─────────────────────────────────────────────────────────────────┐
│                  API 端点映射                                    │
└─────────────────────────────────────────────────────────────────┘

    健康检查
    ┌──────────────────────────────────────────────────────────┐
    │ GET /health                                             │
    │ → 返回服务状态、数据库连接、Redis 连接                    │
    └──────────────────────────────────────────────────────────┘

    聊天
    ┌──────────────────────────────────────────────────────────┐
    │ POST /api/v1/chat/                                      │
    │ → 发送消息，返回完整回复                                  │
    │                                                          │
    │ POST /api/v1/chat/stream                                 │
    │ → 发送消息，SSE 流式返回                                   │
    └──────────────────────────────────────────────────────────┘

    会话管理
    ┌──────────────────────────────────────────────────────────┐
    │ GET /api/v1/chat/sessions                                │
    │ → 列出所有会话                                           │
    │                                                          │
    │ GET /api/v1/chat/sessions/{id}                           │
    │ → 获取会话信息                                           │
    │                                                          │
    │ GET /api/v1/chat/sessions/{id}/history                    │
    │ → 获取会话历史                                           │
    │                                                          │
    │ DELETE /api/v1/chat/sessions/{id}                         │
    │ → 删除会话                                              │
    └──────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────┐
│                  错误处理策略                                    │
└─────────────────────────────────────────────────────────────────┘

    FastAPI HTTPException
           │
           ├─ 400 Bad Request
           │   - 参数验证失败（Pydantic）
           │   - 消息长度超限
           │
           ├─ 404 Not Found
           │   - 会话不存在
           │   - 端点不存在
           │
           ├─ 500 Internal Server Error
           │   - Agent 执行失败
           │   - Redis 连接失败
           │   - 数据库连接失败
           │
           └─ 503 Service Unavailable
               - Redis 不可用
               - 数据库不可用

    日志记录
    ┌──────────────────────────────────────────────────────────┐
    │  logger.info()  - 正常流程日志                           │
    │  logger.warning() - 警告（会话不存在等）                   │
    │  logger.error()   - 错误（执行失败等）                     │
    └──────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────┐
│                  性能优化                                      │
└─────────────────────────────────────────────────────────────────┘

    异步处理
    ┌──────────────────────────────────────────────────────────┐
    │  - FastAPI 异步路由 (async def)                         │
    │  - httpx 异步 HTTP 客户端                                │
    │  - redis.asyncio 异步 Redis                              │
    │  - asyncio 并发处理                                      │
    └──────────────────────────────────────────────────────────┘

    连接池
    ┌──────────────────────────────────────────────────────────┐
    │  - PostgreSQL 连接池 (asyncpg)                          │
    │  - Redis 连接池 (redis-py)                             │
    │  - HTTP 连接池 (httpx)                                  │
    └──────────────────────────────────────────────────────────┘

    缓存策略
    ┌──────────────────────────────────────────────────────────┐
    │  - Redis 会话缓存（1 小时 TTL）                         │
    │  - Agent 组件可复用（未来：全局单例）                    │
    │  - LLM 响应缓存（未实现）                               │
    └──────────────────────────────────────────────────────────┘

---

**文档版本**: v1.0
**最后更新**: 2026-02-03
