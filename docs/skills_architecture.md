# Skills 架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        Skills 层架构                              │
└─────────────────────────────────────────────────────────────────┘

    ┌──────────────────────────────────────────────────────────┐
    │                    SkillRegistry                          │
    │  - 自动注册所有 Skills                                     │
    │  - 提供 Skill 查找和列表功能                                │
    │  - 批量转换为 LangChain Tools                             │
    └────────────┬─────────────────────────────────────────────┘
                 │
                 │ 注册
                 ▼
    ┌──────────────────────────────────────────────────────────┐
    │                    BaseSkill                              │
    │  抽象基类 - 定义统一接口                                    │
    │  - execute(): 执行核心逻辑                                  │
    │  - to_langchain_tool(): 转换为 LangChain Tool             │
    │  - _wrapper(): 内部包装器                                  │
    └────────────┬─────────────────────────────────────────────┘
                 │
                 │ 继承
     ┌───────────┴───────────┬───────────────┬──────────────────┐
     ▼                       ▼               ▼                  ▼
┌──────────────┐    ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│ QueryMetrics │    │ Generate     │  │ Analyze      │  │  Future...   │
│    Skill     │    │   Report     │  │ RootCause    │  │    Skills    │
│              │    │    Skill     │  │    Skill     │  │              │
├──────────────┤    ├──────────────┤  ├──────────────┤  └──────────────┘
│ 指标查询      │    │ 报表生成      │  │ 根因分析      │
│              │    │              │  │              │
│ - 时间筛选    │    │ - CSV 导出   │  │ - 规则引擎    │
│ - 维度聚合    │    │ - JSON 导出  │  │ - 节假日检测  │
│ - 多种聚合    │    │ - 下载链接   │  │ - LLM 深度分析│
└──────┬───────┘    └──────┬───────┘  └──────┬───────┘
       │                   │                  │
       │                   │                  │
       └───────────────────┴──────────────────┘
                           │
                           │ 使用
                           ▼
    ┌──────────────────────────────────────────────────────────┐
    │                    MCPClient                              │
    │  统一的工具调用接口                                        │
    │  - call_tool(): 调用 MCP 工具                             │
    │  - list_tools(): 列出所有工具                              │
    └────────────┬─────────────────────────────────────────────┘
                 │
                 │ 注册并调用
                 ▼
    ┌──────────────────────────────────────────────────────────┐
    │                  MCP Tools 层                             │
    ├──────────────────────────────────────────────────────────┤
    │  ┌────────────────┐        ┌────────────────┐           │
    │  │DatabaseQueryTool│       │HttpRequestTool  │           │
    │  │  数据库查询      │       │  HTTP 请求      │           │
    │  │                │        │                │           │
    │  │ - 参数化查询    │        │ - 超时控制      │           │
    │  │ - SQL 注入防护  │        │ - 重试机制      │           │
    │  │ - 连接池管理    │        │ - 指数退避      │           │
    │  └────────────────┘        └────────────────┘           │
    └──────────────────────────────────────────────────────────┘
                           │
                           │ 访问
                           ▼
    ┌──────────────────────────────────────────────────────────┐
    │                   外部服务                                  │
    ├──────────────────────────────────────────────────────────┤
    │  PostgreSQL (asyncpg)    │    HTTP (httpx)               │
    └──────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────┐
│                    LangChain 集成流                              │
└─────────────────────────────────────────────────────────────────┘

    Skills (Python 对象)          LangChain Tools
    ┌──────────────────┐          ┌──────────────────┐
    │ QueryMetricsSkill│ ───────▶ │ StructuredTool   │
    │ - execute()      │   转换   │ - name           │
    │ - input_schema   │          │ - description    │
    │ - description    │          │ - func           │
    └──────────────────┘          │ - args_schema    │
                                  └────────┬─────────┘
                                           │
                                           │ 用于
                                           ▼
                                  ┌──────────────────┐
                                  │   LangGraph      │
                                  │   StateGraph     │
                                  │                  │
                                  │  - 状态编排       │
                                  │  - Skill 调度     │
                                  │  - 意图路由       │
                                  └──────────────────┘


┌─────────────────────────────────────────────────────────────────┐
│                  Skill 执行流程示例                               │
└─────────────────────────────────────────────────────────────────┘

    用户请求
       │
       ▼
    ┌──────────────────┐
    │  SkillRegistry   │
    │  .get(name)      │
    └────────┬─────────┘
             │
             ▼
    ┌──────────────────┐
    │  QueryMetricsSkill│
    │  .execute()      │
    └────────┬─────────┘
             │
             ▼
    ┌──────────────────┐      ┌──────────────────┐
    │  构建输入参数     │ ───▶ │  Pydantic 验证    │
    │  QueryMetricsInput│      │  input_schema    │
    └────────┬─────────┘      └──────────────────┘
             │
             ▼
    ┌──────────────────┐
    │  调用 MCP 客户端  │
    │  call_tool(      │
    │  "database_query"│
    │  )               │
    └────────┬─────────┘
             │
             ▼
    ┌──────────────────┐      ┌──────────────────┐
    │  MCP Tools 层    │ ───▶ │ DatabaseQueryTool│
    │                  │      │  .execute()      │
    └────────┬─────────┘      └────────┬─────────┘
             │                           │
             ▼                           ▼
    ┌──────────────────┐      ┌──────────────────┐
    │  asyncpg         │      │  PostgreSQL      │
    │  (连接池)        │ ───▶ │  (数据库)        │
    └────────┬─────────┘      └────────┬─────────┘
             │                           │
             ▼                           ▼
    ┌──────────────────┐      ┌──────────────────┐
    │  返回结果        │ ◀──── │  查询结果        │
    │  MCPToolOutput  │      │  (List[dict])    │
    └────────┬─────────┘      └──────────────────┘
             │
             ▼
    ┌──────────────────┐
    │  数据后处理       │
    │  _process_result │
    └────────┬─────────┘
             │
             ▼
    ┌──────────────────┐
    │  返回 SkillOutput│
    │  - success       │
    │  - data          │
    │  - metadata      │
    └──────────────────┘


┌─────────────────────────────────────────────────────────────────┐
│                  AnalyzeRootCauseSkill 混合架构                   │
└─────────────────────────────────────────────────────────────────┘

    输入: 异常指标数据
       │
       ▼
    ┌─────────────────────────────────────┐
    │         规则引擎 (快速)              │
    ├─────────────────────────────────────┤
    │  ┌─────────────────────────────┐    │
    │  │ 1. 系统维护检查              │    │
    │  │    - 查询维护日志表          │    │
    │  └─────────────────────────────┘    │
    │  ┌─────────────────────────────┐    │
    │  │ 2. 节假日效应检测            │    │
    │  │    - holidays 库            │    │
    │  │    - 中国节假日判断          │    │
    │  └─────────────────────────────┘    │
    │  ┌─────────────────────────────┐    │
    │  │ 3. 营销活动结束检测          │    │
    │  │    - 查询营销活动表          │    │
    │  │    - 前后 3 天范围           │    │
    │  └─────────────────────────────┘    │
    └─────────────┬───────────────────────┘
                  │
                  │ 规则不足?
                  ▼
           ┌──────────────┐
           │  是否需要 LLM │
           │  深度分析?    │
           └──────┬───────┘
                  │
         ┌────────┴────────┐
         │                 │
        是                否
         │                 │
         ▼                 ▼
    ┌──────────────┐   直接返回
    │ LLM 深度分析 │   规则结果
    │ (智谱 AI)    │
    │ - 偏差计算   │
    │ - 原因推断   │
    │ - 置信度评分 │
    └──────┬───────┘
           │
           ▼
    ┌───────────────────────────────┐
    │  合并并排序所有可能原因        │
    │  - 按置信度降序排列            │
    │  - 返回 Top-N 原因             │
    └───────────────────────────────┘
                  │
                  ▼
    ┌───────────────────────────────┐
    │  返回 SkillOutput             │
    │  - possible_causes: List[    │
    │      {                        │
    │        "cause": str,          │
    │        "description": str,    │
    │        "confidence": float    │
    │      }                        │
    │    ]                          │
    └───────────────────────────────┘
```

## 关键设计决策

### 1. **统一接口设计**
- 所有 Skills 继承 `BaseSkill`
- 标准化的输入/输出
- 自动错误处理

### 2. **MCP 工具解耦**
- Skills 不直接访问数据库/HTTP
- 通过 MCP 客户端调用底层工具
- 便于测试和替换

### 3. **LangChain 兼容**
- `to_langchain_tool()` 方法
- 无缝集成 LangGraph
- 支持状态图编排

### 4. **混合推理架构**
- 规则引擎（快速、可解释）
- LLM 深度分析（灵活、智能）
- 根据规则数量自动选择

### 5. **可观测性**
- 详细日志记录
- 元数据返回
- 清晰的错误信息

## 数据流

```
用户请求
  → SkillRegistry (获取 Skill)
  → BaseSkill.execute() (执行 Skill)
  → MCPClient.call_tool() (调用 MCP 工具)
  → MCP Tools (DatabaseQuery/HttpRequest)
  → 外部服务 (PostgreSQL/HTTP)
  → 数据后处理
  → SkillOutput (返回结果)
  → LangGraph (状态更新)
```

## 扩展点

### 添加新 Skill:

```python
# 1. 定义输入参数
class MySkillInput(SkillInput):
    param1: str = Field(description="...")
    param2: int = Field(default=10)

# 2. 实现 Skill 类
class MySkill(BaseSkill):
    def __init__(self, mcp_client=None):
        super().__init__(mcp_client)
        self.description = "..."
        self.input_schema = MySkillInput

    async def execute(self, input_data, context):
        # 实现核心逻辑
        pass

# 3. 注册到 SkillRegistry
# 在 registry.py 的 _register_skills() 中添加:
# skills_to_register.append(MySkill(self.mcp_client))
```

### 添加新 MCP Tool:

```python
# 1. 定义输入
class MyToolInput(MCPToolInput):
    param: str = Field(description="...")

# 2. 实现 Tool
class MyTool(BaseMCPTool):
    async def execute(self, input_data, context):
        # 实现核心逻辑
        pass

# 3. 注册到 MCPClient
# 在 client.py 的 _register_tools() 中添加:
# self.tools["my_tool"] = MyTool()
```

---

**文档版本**: v1.0
**最后更新**: 2026-02-03
