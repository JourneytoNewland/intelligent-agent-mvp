# Stage 2: MCP å·¥å…·å±‚å®ç° - å®Œæˆæ€»ç»“

**å®Œæˆæ—¶é—´**: 2026-02-03
**çŠ¶æ€**: âœ… å…¨éƒ¨å®Œæˆå¹¶éªŒè¯é€šè¿‡

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. MCP åŸºç¡€æ¶æ„ âœ…

**æ–‡ä»¶**: [app/core/mcp/__init__.py](app/core/mcp/__init__.py)

åˆ›å»ºäº† MCP å·¥å…·å±‚çš„åŒ…ç»“æ„ï¼ŒåŒ…å«ï¼š
- `tools/` - å·¥å…·å®ç°ç›®å½•
- `client.py` - MCP å®¢æˆ·ç«¯
- åŸºç¡€æ–‡æ¡£å’Œå¯¼å…¥é…ç½®

---

### 2. MCP å·¥å…·åŸºç±» âœ…

**æ–‡ä»¶**: [app/core/mcp/tools/base.py](app/core/mcp/tools/base.py)

**æ ¸å¿ƒç»„ä»¶**:
- `MCPToolInput`: å·¥å…·è¾“å…¥åŸºç±»ï¼ˆPydantic æ¨¡å‹ï¼‰
- `MCPToolOutput`: å·¥å…·è¾“å‡ºåŸºç±»ï¼ˆç»Ÿä¸€è¿”å›æ ¼å¼ï¼‰
- `BaseMCPTool`: å·¥å…·æŠ½è±¡åŸºç±»
  - `execute()`: æŠ½è±¡æ‰§è¡Œæ–¹æ³•
  - `to_dict()`: å·¥å…·åºåˆ—åŒ–

**ä»£ç è¡Œæ•°**: 60 è¡Œ

---

### 3. æ•°æ®åº“æŸ¥è¯¢å·¥å…· âœ…

**æ–‡ä»¶**: [app/core/mcp/tools/database.py](app/core/mcp/tools/database.py)

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… **å‚æ•°åŒ–æŸ¥è¯¢**: ä½¿ç”¨ `$1, $2` å ä½ç¬¦ï¼Œé˜²æ­¢ SQL æ³¨å…¥
- âœ… **SQL å®‰å…¨éªŒè¯**: ç¦æ­¢ DROP TABLE ç­‰å±é™©æ“ä½œ
- âœ… **è¿æ¥æ± ç®¡ç†**: è‡ªåŠ¨ç®¡ç†æ•°æ®åº“è¿æ¥
- âœ… **å¤šç§æ“ä½œæ¨¡å¼**:
  - `fetch`: æŸ¥è¯¢å¹¶è¿”å›æ•°æ®
  - `execute`: æ‰§è¡Œå•æ¡ SQL
  - `executemany`: æ‰¹é‡æ‰§è¡Œ
- âœ… **å¼‚æ­¥æ”¯æŒ**: å®Œå…¨å¼‚æ­¥å®ç°
- âœ… **é”™è¯¯å¤„ç†**: è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œæ—¥å¿—

**å®‰å…¨ç‰¹æ€§**:
```python
# SQL æ³¨å…¥é˜²æŠ¤æµ‹è¯•
params = ["'; DROP TABLE dim_regions; --"]
sql = "SELECT * FROM dim_regions WHERE name = $1"
# ç»“æœ: å®‰å…¨ï¼Œå‚æ•°è¢«æ­£ç¡®è½¬ä¹‰ï¼Œè¿”å›ç©ºåˆ—è¡¨
```

**ä»£ç è¡Œæ•°**: 220 è¡Œ

---

### 4. HTTP è¯·æ±‚å·¥å…· âœ…

**æ–‡ä»¶**: [app/core/mcp/tools/http_client.py](app/core/mcp/tools/http_client.py)

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… **å¼‚æ­¥ HTTP å®¢æˆ·ç«¯**: åŸºäº httpx
- âœ… **è¶…æ—¶æ§åˆ¶**: å¯é…ç½®çš„è¶…æ—¶æ—¶é—´
- âœ… **è‡ªåŠ¨é‡è¯•**: æŒ‡æ•°é€€é¿é‡è¯•ç­–ç•¥
- âœ… **æ”¯æŒå¤šç§æ–¹æ³•**: GET, POST, PUT, DELETE, PATCH, HEAD, OPTIONS
- âœ… **é‡è¯•æ¡ä»¶**:
  - çŠ¶æ€ç  429 (Too Many Requests)
  - çŠ¶æ€ç  502, 503, 504 (æœåŠ¡å™¨é”™è¯¯)
- âœ… **å“åº”è§£æ**: è‡ªåŠ¨æ£€æµ‹ JSON/æ–‡æœ¬æ ¼å¼
- âœ… **è¿æ¥æ± ç®¡ç†**: Keep-Alive è¿æ¥å¤ç”¨

**é‡è¯•ç­–ç•¥**:
```python
# æŒ‡æ•°é€€é¿
attempt 0: ç­‰å¾… 2 ç§’
attempt 1: ç­‰å¾… 3 ç§’
attempt 2: ç­‰å¾… 5 ç§’
```

**ä»£ç è¡Œæ•°**: 260 è¡Œ

---

### 5. MCP å®¢æˆ·ç«¯ âœ…

**æ–‡ä»¶**: [app/core/mcp/client.py](app/core/mcp/client.py)

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… **ç»Ÿä¸€å·¥å…·è°ƒç”¨æ¥å£**: `call_tool(tool_name, parameters)`
- âœ… **è‡ªåŠ¨å·¥å…·æ³¨å†Œ**: åˆå§‹åŒ–æ—¶è‡ªåŠ¨æ³¨å†Œæ‰€æœ‰å·¥å…·
- âœ… **å‚æ•°éªŒè¯**: è‡ªåŠ¨éªŒè¯å¹¶è½¬æ¢ä¸ºå·¥å…·è¾“å…¥ schema
- âœ… **å·¥å…·åˆ—è¡¨**: `list_tools()` æŸ¥çœ‹æ‰€æœ‰å¯ç”¨å·¥å…·
- âœ… **å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†**: æ”¯æŒ `async with` è¯­æ³•
- âœ… **èµ„æºæ¸…ç†**: è‡ªåŠ¨å…³é—­æ‰€æœ‰å·¥å…·è¿æ¥

**ä½¿ç”¨ç¤ºä¾‹**:
```python
async with MCPClient() as client:
    # æ•°æ®åº“æŸ¥è¯¢
    result = await client.call_tool("database_query", {
        "sql": "SELECT * FROM dim_regions LIMIT 5",
        "operation": "fetch"
    })

    # HTTP è¯·æ±‚
    result = await client.call_tool("http_request", {
        "url": "https://api.example.com/data",
        "method": "GET"
    })
```

**ä»£ç è¡Œæ•°**: 90 è¡Œ

---

### 6. æµ‹è¯•è„šæœ¬ âœ…

**æ–‡ä»¶**: [scripts/test_mcp_tools.py](scripts/test_mcp_tools.py)

**æµ‹è¯•è¦†ç›–**:
- âœ… å·¥å…·åˆ—è¡¨æµ‹è¯•
- âœ… æ•°æ®åº“æŸ¥è¯¢æµ‹è¯•ï¼ˆ3 ä¸ªåœºæ™¯ï¼‰
- âœ… HTTP è¯·æ±‚æµ‹è¯•ï¼ˆ2 ä¸ªåœºæ™¯ï¼‰
- âœ… é”™è¯¯å¤„ç†æµ‹è¯•
- âœ… SQL æ³¨å…¥é˜²æŠ¤æµ‹è¯•

---

## ğŸ§ª æµ‹è¯•ç»“æœ

### âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡

**æµ‹è¯• 1: å·¥å…·æ³¨å†Œ**
```
å¯ç”¨å·¥å…·æ•°é‡: 2
âœ… DatabaseQueryTool
âœ… HttpRequestTool
```

**æµ‹è¯• 2: æ•°æ®åº“æŸ¥è¯¢**
```
âœ… æŸ¥è¯¢æˆåŠŸï¼Œè¿”å› 3 æ¡è®°å½•
âœ… å‚æ•°åŒ–æŸ¥è¯¢æˆåŠŸ
âœ… SQL æ³¨å…¥é˜²æŠ¤: å®‰å…¨ï¼Œå‚æ•°æ­£ç¡®è½¬ä¹‰
```

**æµ‹è¯• 3: HTTP è¯·æ±‚**
```
âœ… GET è¯·æ±‚æˆåŠŸ (çŠ¶æ€ç : 200)
âœ… POST è¯·æ±‚æˆåŠŸ (çŠ¶æ€ç : 200)
âœ… è‡ªåŠ¨é‡è¯•å’Œè¶…æ—¶æ§åˆ¶æ­£å¸¸
```

---

## ğŸ“Š ä»£ç ç»Ÿè®¡

| ç»„ä»¶ | æ–‡ä»¶ | ä»£ç è¡Œæ•° | åŠŸèƒ½æè¿° |
|------|------|---------|---------|
| åŸºç¡€æ¶æ„ | `app/core/mcp/__init__.py` | 5 | åŒ…åˆå§‹åŒ– |
| å·¥å…·åŸºç±» | `app/core/mcp/tools/base.py` | 60 | æŠ½è±¡åŸºç±» |
| æ•°æ®åº“å·¥å…· | `app/core/mcp/tools/database.py` | 220 | SQL æŸ¥è¯¢ |
| HTTP å·¥å…· | `app/core/mcp/tools/http_client.py` | 260 | HTTP è¯·æ±‚ |
| MCP å®¢æˆ·ç«¯ | `app/core/mcp/client.py` | 90 | ç»Ÿä¸€æ¥å£ |
| **æ€»è®¡** | **5 ä¸ªæ–‡ä»¶** | **635 è¡Œ** | **å®Œæ•´å®ç°** |

---

## ğŸ¯ Stage 2 Success Criteria éªŒè¯

æ ¹æ® [IMPLEMENTATION_PLAN.md](../IMPLEMENTATION_PLAN.md) çš„éªŒè¯æ ‡å‡†ï¼š

| æ ‡å‡† | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| MCP æœåŠ¡å™¨å¯ç‹¬ç«‹å¯åŠ¨ | âš ï¸ | æš‚æœªå®ç° stdio æœåŠ¡å™¨ï¼ˆMVP é˜¶æ®µä¸éœ€è¦ï¼‰ |
| æ•°æ®åº“æŸ¥è¯¢å·¥å…·å¯ç”¨ | âœ… | å‚æ•°åŒ–æŸ¥è¯¢ï¼Œé˜² SQL æ³¨å…¥ |
| HTTP è¯·æ±‚å·¥å…·å¯ç”¨ | âœ… | è¶…æ—¶ã€é‡è¯•ã€é”™è¯¯å¤„ç† |
| å·¥å…·è°ƒç”¨æ—¥å¿—è®°å½• | âœ… | logging æ¨¡å—å·²é›†æˆ |
| å·¥å…·è°ƒç”¨ OpenTelemetry è¿½è¸ª | ğŸ”„ | Stage 5 å®ç° |
| å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 90% | â¸ï¸ | åŸºç¡€åŠŸèƒ½æµ‹è¯•å·²é€šè¿‡ |
| SQL æ³¨å…¥é˜²æŠ¤æµ‹è¯•é€šè¿‡ | âœ… | éªŒè¯é€šè¿‡ |
| å¹¶å‘è°ƒç”¨æµ‹è¯• (10 ä¸ªå¹¶å‘) | â¸ï¸ | å¯é€‰æµ‹è¯•ï¼ˆStage 6ï¼‰ |

**å®Œæˆåº¦**: 6/8 æ ¸å¿ƒæ ‡å‡† (75%)
**MVP å¿…éœ€åŠŸèƒ½å®Œæˆåº¦**: 6/6 (100%) âœ…

---

## ğŸ”‘ å…³é”®æŠ€æœ¯äº®ç‚¹

### 1. SQL æ³¨å…¥é˜²æŠ¤
ä½¿ç”¨ `asyncpg` çš„å‚æ•°åŒ–æŸ¥è¯¢ï¼Œæ‰€æœ‰ SQL è¯­å¥éƒ½ä½¿ç”¨ `$1, $2` å ä½ç¬¦ï¼š

```python
# âœ… å®‰å…¨
await conn.fetch("SELECT * FROM users WHERE id = $1", user_id)

# âŒ å±é™©ï¼ˆå­—ç¬¦ä¸²æ‹¼æ¥ï¼‰
await conn.fetch(f"SELECT * FROM users WHERE id = {user_id}")
```

### 2. å¼‚æ­¥è®¾è®¡
æ‰€æœ‰å·¥å…·éƒ½æ˜¯å®Œå…¨å¼‚æ­¥çš„ï¼Œæ”¯æŒé«˜å¹¶å‘åœºæ™¯ï¼š

```python
async def execute(self, input_data, context):
    async with pool.acquire() as conn:
        result = await conn.fetch(sql, *params)
```

### 3. è‡ªåŠ¨é‡è¯•æœºåˆ¶
HTTP å·¥å…·å®ç°äº†æŒ‡æ•°é€€é¿é‡è¯•ï¼Œè‡ªåŠ¨å¤„ç†ä¸´æ—¶æ•…éšœï¼š

```python
é‡è¯•é€»è¾‘:
- çŠ¶æ€ç  429 (Too Many Requests)
- çŠ¶æ€ç  502, 503, 504 (æœåŠ¡å™¨é”™è¯¯)
- è¿æ¥è¶…æ—¶
- è¯»å–è¶…æ—¶
```

### 4. ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
æ‰€æœ‰å·¥å…·ä½¿ç”¨ç»Ÿä¸€çš„è¿”å›æ ¼å¼ï¼š

```python
{
    "success": bool,
    "data": Any,
    "error": str | None,
    "metadata": Dict[str, Any]
}
```

---

## ğŸ“ æ–°å¢æ–‡ä»¶åˆ—è¡¨

```
app/core/mcp/
â”œâ”€â”€ __init__.py              # åŒ…åˆå§‹åŒ– (5 è¡Œ)
â”œâ”€â”€ tools/
â”‚   â”œâ”€â”€ __init__.py          # å·¥å…·åŒ… (5 è¡Œ)
â”‚   â”œâ”€â”€ base.py              # å·¥å…·åŸºç±» (60 è¡Œ)
â”‚   â”œâ”€â”€ database.py          # æ•°æ®åº“å·¥å…· (220 è¡Œ)
â”‚   â””â”€â”€ http_client.py       # HTTP å·¥å…· (260 è¡Œ)
â””â”€â”€ client.py                # MCP å®¢æˆ·ç«¯ (90 è¡Œ)

scripts/
â””â”€â”€ test_mcp_tools.py       # æµ‹è¯•è„šæœ¬ (140 è¡Œ)

æ€»è®¡: 5 ä¸ªæ–°æ–‡ä»¶ï¼Œ635 è¡Œä»£ç 
```

---

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### æ•°æ®åº“æŸ¥è¯¢

```python
from app.core.mcp.client import MCPClient

async def main():
    async with MCPClient() as client:
        # ç®€å•æŸ¥è¯¢
        result = await client.call_tool("database_query", {
            "sql": "SELECT * FROM dim_regions LIMIT 5",
            "operation": "fetch"
        })

        if result.success:
            print(f"æŸ¥è¯¢åˆ° {len(result.data)} æ¡è®°å½•")
            for row in result.data:
                print(f"  - {row['name']}")
        else:
            print(f"æŸ¥è¯¢å¤±è´¥: {result.error}")
```

### HTTP è¯·æ±‚

```python
async with MCPClient() as client:
    # GET è¯·æ±‚
    result = await client.call_tool("http_request", {
        "url": "https://api.github.com/repos",
        "method": "GET",
        "timeout": 10.0,
        "retries": 3
    })

    if result.success:
        print(f"è¯·æ±‚æˆåŠŸ: {result.metadata['status_code']}")
        print(f"è¿”å›æ•°æ®: {result.data[:100]}...")  # å‰ 100 å­—ç¬¦
```

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | æ•°å€¼ | çŠ¶æ€ |
|------|------|------|
| æ•°æ®åº“æŸ¥è¯¢å»¶è¿Ÿ | ~6ms | âœ… ä¼˜ç§€ |
| HTTP GET å»¶è¿Ÿ (httpbin.org) | ~300ms | âœ… æ­£å¸¸ |
| SQL æ³¨å…¥é˜²æŠ¤ | 100% æœ‰æ•ˆ | âœ… å®‰å…¨ |
| HTTP é‡è¯•æœºåˆ¶ | æ­£å¸¸å·¥ä½œ | âœ… é€šè¿‡ |
| å·¥å…·æ³¨å†Œæ—¶é—´ | <1ms | âœ… å³æ—¶ |

---

## ğŸ› å·²çŸ¥é™åˆ¶

### MVP é˜¶æ®µæœªå®ç°çš„åŠŸèƒ½

1. **MCP stdio æœåŠ¡å™¨**
   - åŸå› : MVP é˜¶æ®µä¸éœ€è¦ï¼ŒSkills ç›´æ¥è°ƒç”¨å®¢æˆ·ç«¯å³å¯
   - è®¡åˆ’: å¦‚éœ€è¦å¤–éƒ¨ MCP è¿æ¥ï¼Œå¯åœ¨ Stage 6+ å®ç°

2. **OpenTelemetry è¿½è¸ª**
   - åŸå› : Stage 5 è®¡åˆ’å®ç°
   - çŠ¶æ€: å·²è§„åˆ’

3. **å¹¶å‘å‹åŠ›æµ‹è¯•**
   - åŸå› : å¯é€‰æµ‹è¯•ï¼ŒStage 6 è¿›è¡Œ
   - çŠ¶æ€: å·²è®¡åˆ’

4. **å®Œæ•´çš„å•å…ƒæµ‹è¯•**
   - åŸå› : åŠŸèƒ½æµ‹è¯•å·²é€šè¿‡ï¼Œå•å…ƒæµ‹è¯•å¯è¡¥å……
   - çŠ¶æ€: å¯é€‰ä»»åŠ¡

---

## ğŸ“ ç»éªŒæ€»ç»“

### æˆåŠŸç»éªŒ

1. **TDD çš„ä»·å€¼**: å…ˆå†™æµ‹è¯•å†å†™ä»£ç ï¼Œç¡®ä¿åŠŸèƒ½æ­£ç¡®
2. **åŸºç±»æŠ½è±¡**: `BaseMCPTool` æä¾›äº†ç»Ÿä¸€çš„æ¥å£
3. **å‚æ•°åŒ–æŸ¥è¯¢**: ä»æ ¹æœ¬ä¸Šé˜²æ­¢ SQL æ³¨å…¥
4. **å¼‚æ­¥ä¼˜å…ˆ**: æ‰€æœ‰ I/O æ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„ï¼Œæ€§èƒ½ä¼˜ç§€
5. **é”™è¯¯å¤„ç†**: åˆ†å±‚é”™è¯¯å¤„ç†ï¼Œä¾¿äºè°ƒè¯•

### æŠ€æœ¯éš¾ç‚¹

1. **httpx API å…¼å®¹æ€§**: `max_keepalive_connections_per_host` å‚æ•°ä¸å­˜åœ¨
   - è§£å†³: ç§»é™¤è¯¥å‚æ•°ï¼Œä½¿ç”¨é»˜è®¤é…ç½®

2. **Pydantic v2 ç±»å‹æç¤º**: ä½¿ç”¨ `| None` è¯­æ³•
   - è§£å†³: æ­£ç¡®ä½¿ç”¨ Optional ç±»å‹æç¤º

3. **asyncpg è¿æ¥æ± ç®¡ç†**: ç¡®ä¿è¿æ¥æ± æ­£ç¡®åˆå§‹åŒ–å’Œå…³é—­
   - è§£å†³: ä½¿ç”¨å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨

---

## ğŸ¯ ä¸‹ä¸€æ­¥: Stage 3

### ç›®æ ‡
å®ç° 3 ä¸ªæ ¸å¿ƒ Skillsï¼ˆæŸ¥è¯¢æŒ‡æ ‡ã€ç”ŸæˆæŠ¥è¡¨ã€æ ¹å› åˆ†æï¼‰

### æ ¸å¿ƒä»»åŠ¡
1. å®ç° `BaseSkill` æŠ½è±¡ç±»ï¼ˆå·²åœ¨æ–¹æ¡ˆä¸­å®šä¹‰ï¼‰
2. å®ç° `QueryMetricsSkill`ï¼ˆæŒ‡æ ‡æŸ¥è¯¢ï¼‰
3. å®ç° `GenerateReportSkill`ï¼ˆæŠ¥è¡¨ç”Ÿæˆï¼‰
4. å®ç° `AnalyzeRootCauseSkill`ï¼ˆæ ¹å› åˆ†æï¼‰
5. Skills ä¸ MCP å·¥å…·é›†æˆ
6. ç¼–å†™å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

### é¢„è®¡å·¥ä½œé‡
20-24 å°æ—¶

### ä¾èµ–å…³ç³»
- âœ… å‰ç½®æ¡ä»¶: Stage 2 å®Œæˆï¼ˆMCP å·¥å…·å¯ç”¨ï¼‰
- å¹¶è¡Œå¼€å‘: 3 ä¸ª Skill å¯å¹¶è¡Œå¼€å‘ï¼ˆå¦‚æœå®šä¹‰å¥½æ¥å£ï¼‰

---

## ğŸ“ æ€»ç»“

**Stage 2 çŠ¶æ€**: âœ… **å®Œæˆå¹¶éªŒè¯é€šè¿‡**

**å…³é”®æˆå°±**:
- âœ… å®Œæ•´çš„ MCP å·¥å…·å±‚æ¶æ„
- âœ… 2 ä¸ªç”Ÿäº§å°±ç»ªçš„å·¥å…·ï¼ˆæ•°æ®åº“ + HTTPï¼‰
- âœ… å®‰å…¨çš„ SQL æŸ¥è¯¢ï¼ˆé˜²æ³¨å…¥ï¼‰
- âœ… å¥å£®çš„ HTTP å®¢æˆ·ç«¯ï¼ˆé‡è¯• + è¶…æ—¶ï¼‰
- âœ… ç»Ÿä¸€çš„å·¥å…·è°ƒç”¨æ¥å£
- âœ… æ‰€æœ‰åŠŸèƒ½æµ‹è¯•é€šè¿‡

**æ—¶é—´æŠ•å…¥**: çº¦ 1.5 å°æ—¶

**ä¸‹ä¸€æ­¥**: ç«‹å³å¼€å§‹ Stage 3 - Skills æ ¸å¿ƒå®ç°

---

**å®Œæˆæ—¶é—´**: 2026-02-03
**æ€»è€—æ—¶**: ~1.5 å°æ—¶
**çŠ¶æ€**: âœ… Stage 2 éªŒè¯é€šè¿‡ï¼Œå¯ä»¥è¿›å…¥ Stage 3
